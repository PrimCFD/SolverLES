name: Tests · CPU/GPU/MPI (containerized)

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # One-time per workflow run: prefetch deps to speed up all matrix jobs
  prefetch-deps:
    name: Prefetch third-party archives
    runs-on: ubuntu-latest
    container: ubuntu:24.04
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal build tools (inside container)
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            ca-certificates git cmake ninja-build build-essential gfortran

      - name: Prefetch third-party sources into extern/
        run: |
          bash scripts/prefetch_third_party.sh

      - name: Upload extern/ cache for downstream jobs
        uses: actions/upload-artifact@v4
        with:
          name: extern-cache
          path: extern/
          if-no-files-found: error
          retention-days: 7

  # Matrix of test types / environments (CPU+MPI in Ubuntu container; GPU in CUDA container)
  tests:
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    name: ${{ matrix.name }}
    needs: prefetch-deps
    runs-on: ${{ matrix.runs_on }}
    container:
      image: ${{ matrix.container_image }}
      options: ${{ matrix.container_options || '' }}
    timeout-minutes: 60
    continue-on-error: ${{ matrix.allow_fail || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Unit (CPU)
            test: unit
            runs_on: ubuntu-latest
            container_image: ubuntu:24.04
            mpi: false
            gpu: false

          - name: Perf (CPU)
            test: perf
            runs_on: ubuntu-latest
            container_image: ubuntu:24.04
            mpi: false
            gpu: false

          - name: MPI (emulated)
            test: mpi
            runs_on: ubuntu-latest
            container_image: ubuntu:24.04
            mpi: true
            mpi_mode: emulate
            np: 2
            gpu: false

          - name: Perf (GPU)
            test: perf
            # GPU still requires a GPU host; container isolates toolchain
            runs_on: [self-hosted, linux, x64, gpu]
            container_image: nvidia/cuda:12.4.1-devel-ubuntu22.04
            container_options: --gpus all
            mpi: false
            gpu: true
            allow_fail: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch extern/ from prefetch job
        uses: actions/download-artifact@v4
        with:
          name: extern-cache
          path: extern/

      - name: Ensure extern/ exists (fallback safety)
        shell: bash
        run: |
          if [ ! -d extern ] || [ -z "$(ls -A extern)" ]; then
            echo "extern/ missing, running prefetch_third_party.sh here as a fallback…"
            bash scripts/prefetch_third_party.sh
          fi
          ls -l extern || true

      - name: Install build toolchain (inside container)
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            cmake ninja-build build-essential gfortran git

      - name: Install MPI (when needed)
        if: ${{ matrix.mpi }}
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            openmpi-bin libopenmpi-dev

      - name: CPU Unit tests
        if: ${{ matrix.test == 'unit' }}
        env:
          OFFLINE: "1"
        run: ./scripts/run_unit_tests.sh

      - name: CPU Perf tests
        if: ${{ matrix.test == 'perf' && !matrix.gpu }}
        env:
          OFFLINE: "1"
          ENABLE_CUDA: "OFF"   # keep CPU-only path explicit
          CMAKE_BUILD_TYPE: Release
        run: ./scripts/run_perf_tests.sh

      - name: MPI tests (emulated on CI)
        if: ${{ matrix.test == 'mpi' }}
        env:
          OFFLINE: "1"
        run: ./scripts/run_mpi_tests.sh --mode ${{ matrix.mpi_mode || 'auto' }} --np ${{ matrix.np || 2 }} --keep-going

      - name: GPU Perf tests
        if: ${{ matrix.test == 'perf' && matrix.gpu }}
        env:
          OFFLINE: "1"
          CMAKE_BUILD_TYPE: Release
        run: |
          nvidia-smi || true
          nvcc --version || true
          ./scripts/run_perf_tests.sh

      - name: Upload test reports (JUnit XML)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.name }} · reports
          path: |
            build-unit/test-reports/unit/**
            build-perf/test-reports/perf/**
            build-mpi/test-reports/mpi/**
          if-no-files-found: ignore
          retention-days: 7
