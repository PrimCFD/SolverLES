#=======================
# KolmoPlas config (v0.5)
#=======================


# Short identifier for outputs (writer will create path/<case>.h5, path/<case>.xmf, etc.)
case: hello_mesh


# Mesh (local box on each rank, ghosts are uniform)
mesh:
  local: [32, 32, 32] # required (ints)
  ng: 2 # required (uniform ghost width)
  periodic: [false, false, false] # optional (reserved)


# Time integration and writer cadence
time:
  dt: 5.0e-2 # required (seconds) => fixed stepping
  t_end: 1.0 # required (seconds)
  write_every: # choose one; if both set, 'steps' wins
    steps: 1 # write every N steps
    # time: 0.05 # OR every T seconds (converted with ceil(T/dt))


# I/O policy & backend
io:
  backend: xdmf # xdmf(single rank only) | cgns (parrallel writer) | null
  xdmf_version : v3 # xdmf version
  path: out # output directory
  precision: native # native | float64 | float32 (packing override)
  async: # optional background writer
    enabled: true
    max_queue: 8 # 0 = unbounded
    drop_on_overflow: true # drop writes when queue is full (protects cadence)
  preflight: # optional resource checks (RAM/disk)
    enabled: true
    ram_bytes: auto # auto | integer bytes (e.g., "17179869184")
    disk_bytes: auto # auto | integer bytes


# Runtime-loaded physics libraries (in this order)
plugins:
- lib: libphysics_fluids.so
# - lib: libphysics_heat.so


# Program selector + free-form KV passed to plugin (strings on both sides)
program:
  key: les
  params:
    dx: "1"
    dy: "1" 
    dz: "1"
    rho: "1"
    nu: "1e-3"
    Cs: "0.16"

    scheme: "piso"                 # Projection loop (PISO/IPISO)

    # --- Time integration (advection + diffusion) ---
    time_scheme: "abm3"            # "fe"  = all Forward Euler
                                  # "be"  = BE diffusion (residual-driven), AB1 advection
                                  # "abm3"= ABM3 advection (AB1/AB2 startup), diffusion chosen by be_max_iters

    # Advection controls
    advect: "on"                   # "on" to include -(u·∇)u, "off" to disable advection entirely
    adv_blend: "0.0"               # 0..1 limiter blend used by KK3 advection (0 = centered, 1 = upwindier)

    # Diffusion controls (used when time_scheme is "be" OR when "abm3" + be_max_iters>0)
    pred_imp_solver: "rbgs"        # "rbgs" (red-black Gauss–Seidel) or "jacobi"
    be_rtol: "1e-3"                # Relative residual stop (||r||/||rhs||); tighter => more work
    be_max_iters: "50"             # >0 => BE diffusion; set to "0" to use FE diffusion (even with time_scheme=abm3)
    pred_imp_order: "2"           # 1=BE, 2=CN (recommended for pure diffusion), 3=AM3

    # Poisson / pressure projection
    p_iters: "3"                   # >=1 to run pressure Poisson; "0" writes p=0 (no projection this step)
    div_tol: "1e-7"                # Target divergence tolerance used by the Poisson solve (projection phase)

    bc.u.west:   "dirichlet:0"
    bc.u.east:   "dirichlet:0"
    bc.u.south:  "dirichlet:0"
    bc.u.north:  "dirichlet:1"   # moving lid
    bc.u.bottom: "dirichlet:0"
    bc.u.top:    "dirichlet:0"
    bc.v.*: "dirichlet:0" # * => all faces
    bc.w.*: "dirichlet:0"
    bc.p.*: "neumann:0"


# Field output selection by name (the app allocates/registers these as doubles)
fields:
  output: [u, v, w, p, nu_t]